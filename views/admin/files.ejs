<%- include('../partials/header') %>

<!-- Toast -->
<div id="toastContainer" class="fixed top-20 right-4 z-50"></div>

<!-- Breadcrumb / Path Bar -->
<div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 mb-4 px-5 py-3">
  <div class="flex items-center justify-between flex-wrap gap-3">
    <div class="flex items-center gap-2 min-w-0 flex-1">
      <i class="bi bi-folder-fill text-amber-500 text-lg flex-shrink-0"></i>
      <div class="flex items-center gap-1 text-sm overflow-x-auto whitespace-nowrap" id="breadcrumb">
        <% const parts = currentPath.split('/').filter(Boolean); %>
        <a href="/admin/files?path=/" class="text-brand-600 dark:text-brand-400 hover:underline font-medium">/</a>
        <% let buildPath = ''; %>
        <% parts.forEach((part, i) => { %>
          <% buildPath += '/' + part; %>
          <span class="text-gray-400">/</span>
          <% if (i === parts.length - 1) { %>
            <span class="text-gray-700 dark:text-gray-300 font-medium"><%= part %></span>
          <% } else { %>
            <a href="/admin/files?path=<%= encodeURIComponent(buildPath) %>" class="text-brand-600 dark:text-brand-400 hover:underline"><%= part %></a>
          <% } %>
        <% }); %>
      </div>
    </div>
    <div class="flex items-center gap-2 flex-shrink-0">
      <label class="flex items-center gap-1.5 text-xs text-gray-500 cursor-pointer">
        <input type="checkbox" id="showHidden" <%= showHidden ? 'checked' : '' %> onchange="toggleHidden()" class="rounded border-gray-300 dark:border-gray-700">
        Hidden
      </label>
      <button onclick="openNewFileModal()" class="px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="New File">
        <i class="bi bi-file-earmark-plus mr-1"></i>File
      </button>
      <button onclick="openNewFolderModal()" class="px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="New Folder">
        <i class="bi bi-folder-plus mr-1"></i>Folder
      </button>
    </div>
  </div>
</div>

<!-- File List -->
<div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-gray-100 dark:border-gray-800 text-left text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">
          <th class="px-5 py-3 font-medium">Name</th>
          <th class="px-5 py-3 font-medium w-28">Size</th>
          <th class="px-5 py-3 font-medium w-44">Modified</th>
          <th class="px-5 py-3 font-medium text-right w-32">Actions</th>
        </tr>
      </thead>
      <tbody id="fileTableBody">
        <% if (items.length === 0) { %>
        <tr>
          <td colspan="4" class="text-center py-16 text-gray-400">
            <i class="bi bi-folder2-open text-5xl"></i>
            <p class="mt-3 font-medium">Empty directory</p>
          </td>
        </tr>
        <% } else { %>
        <% items.forEach(item => { %>
        <tr class="border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group">
          <td class="px-5 py-2.5">
            <% if (item.type === 'directory') { %>
              <a href="/admin/files?path=<%= encodeURIComponent(item.path) %><%= showHidden ? '&hidden=1' : '' %>" class="flex items-center gap-2.5 text-gray-800 dark:text-gray-200 hover:text-brand-600 dark:hover:text-brand-400 transition-colors">
                <i class="bi bi-folder-fill text-amber-500 text-base"></i>
                <span class="font-medium"><%= item.name %></span>
              </a>
            <% } else { %>
              <button onclick="viewFile('<%= item.path.replace(/'/g, "\\'") %>')" class="flex items-center gap-2.5 text-gray-800 dark:text-gray-200 hover:text-brand-600 dark:hover:text-brand-400 transition-colors text-left">
                <i class="bi bi-file-earmark-text text-gray-400 text-base"></i>
                <span><%= item.name %></span>
              </button>
            <% } %>
          </td>
          <td class="px-5 py-2.5 text-xs text-gray-400">
            <% if (item.type === 'file' && item.size !== null) { %>
              <%= item.size < 1024 ? item.size + ' B' : item.size < 1048576 ? (item.size/1024).toFixed(1) + ' KB' : (item.size/1048576).toFixed(1) + ' MB' %>
            <% } else { %>—<% } %>
          </td>
          <td class="px-5 py-2.5 text-xs text-gray-400">
            <% if (item.modified) { %>
              <%= new Date(item.modified).toLocaleString() %>
            <% } else { %>—<% } %>
          </td>
          <td class="px-5 py-2.5 text-right">
            <% if (item.name !== '..') { %>
            <div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <% if (item.type === 'file') { %>
              <button onclick="viewFile('<%= item.path.replace(/'/g, "\\'") %>')" class="p-1.5 rounded-lg hover:bg-brand-100 dark:hover:bg-brand-900/30 text-brand-600 dark:text-brand-400 transition-colors" title="View/Edit">
                <i class="bi bi-pencil-square"></i>
              </button>
              <% } %>
              <button onclick="renameItem('<%= item.path.replace(/'/g, "\\'") %>', '<%= item.name.replace(/'/g, "\\'") %>')" class="p-1.5 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/30 text-amber-600 dark:text-amber-400 transition-colors" title="Rename">
                <i class="bi bi-pencil"></i>
              </button>
              <button onclick="deleteItem('<%= item.path.replace(/'/g, "\\'") %>', '<%= item.name.replace(/'/g, "\\'") %>')" class="p-1.5 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 dark:text-red-400 transition-colors" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <% } %>
          </td>
        </tr>
        <% }); %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- File Editor Modal -->
<div id="editorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="fixed inset-0 bg-black/50" onclick="closeEditor()"></div>
  <div class="relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 w-full max-w-4xl max-h-[90vh] flex flex-col">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-2 min-w-0">
        <i class="bi bi-file-earmark-code text-brand-500"></i>
        <h3 class="text-sm font-semibold truncate" id="editorTitle">File</h3>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-400" id="editorSize"></span>
        <button onclick="saveFile()" id="saveBtn" class="px-3 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-xs font-medium rounded-lg transition-colors">
          <i class="bi bi-check-lg mr-1"></i>Save
        </button>
        <button onclick="closeEditor()" class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>
    <div class="flex-1 overflow-hidden p-1">
      <textarea id="editorContent" class="w-full h-full px-4 py-3 bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-200 font-mono text-sm outline-none resize-none rounded-xl border border-gray-200 dark:border-gray-800" spellcheck="false"></textarea>
    </div>
  </div>
</div>

<!-- New File Modal -->
<div id="newFileModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="fixed inset-0 bg-black/50" onclick="closeNewFileModal()"></div>
  <div class="relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 w-full max-w-md">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
      <h3 class="font-semibold"><i class="bi bi-file-earmark-plus text-brand-500 mr-2"></i>New File</h3>
    </div>
    <div class="px-6 py-5">
      <label class="block text-sm font-medium mb-2">File Name</label>
      <input type="text" id="newFileName" placeholder="e.g. config.js" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:ring-2 focus:ring-brand-500 outline-none">
    </div>
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex justify-end gap-3">
      <button onclick="closeNewFileModal()" class="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 text-sm font-medium transition-colors">Cancel</button>
      <button onclick="createNewFile()" class="px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium transition-colors">Create</button>
    </div>
  </div>
</div>

<!-- New Folder Modal -->
<div id="newFolderModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="fixed inset-0 bg-black/50" onclick="closeNewFolderModal()"></div>
  <div class="relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 w-full max-w-md">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
      <h3 class="font-semibold"><i class="bi bi-folder-plus text-amber-500 mr-2"></i>New Folder</h3>
    </div>
    <div class="px-6 py-5">
      <label class="block text-sm font-medium mb-2">Folder Name</label>
      <input type="text" id="newFolderName" placeholder="e.g. scripts" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 focus:ring-2 focus:ring-brand-500 outline-none">
    </div>
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex justify-end gap-3">
      <button onclick="closeNewFolderModal()" class="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 text-sm font-medium transition-colors">Cancel</button>
      <button onclick="createNewFolder()" class="px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium transition-colors">Create</button>
    </div>
  </div>
</div>

<input type="hidden" id="csrfToken" value="<%= csrfToken %>">
<input type="hidden" id="currentPath" value="<%= currentPath %>">

<script>
const csrf = document.getElementById('csrfToken').value;
const currentDir = document.getElementById('currentPath').value;

function showToast(msg, type = 'success') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `mb-2 px-4 py-3 rounded-xl shadow-lg text-sm font-medium transition-all duration-300 transform translate-x-full ${
    type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
  }`;
  toast.textContent = msg;
  container.appendChild(toast);
  requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
  setTimeout(() => {
    toast.classList.add('translate-x-full');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Toggle hidden files
function toggleHidden() {
  const show = document.getElementById('showHidden').checked;
  window.location.href = '/admin/files?path=' + encodeURIComponent(currentDir) + (show ? '&hidden=1' : '');
}

// View/edit file
let currentFilePath = '';
async function viewFile(filePath) {
  currentFilePath = filePath;
  try {
    const res = await fetch('/admin/api/files/read?path=' + encodeURIComponent(filePath), {
      headers: { 'CSRF-Token': csrf }
    });
    const data = await res.json();
    if (!data.success) { showToast(data.message, 'error'); return; }

    document.getElementById('editorTitle').textContent = data.name;
    document.getElementById('editorSize').textContent = data.size < 1024 ? data.size + ' B' : (data.size/1024).toFixed(1) + ' KB';
    document.getElementById('editorContent').value = data.content;
    document.getElementById('editorModal').classList.remove('hidden');
    document.getElementById('editorContent').focus();
  } catch (err) {
    showToast('Failed to read file', 'error');
  }
}

function closeEditor() {
  document.getElementById('editorModal').classList.add('hidden');
}

// Save file
async function saveFile() {
  const content = document.getElementById('editorContent').value;
  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split mr-1"></i>Saving...';

  try {
    const res = await fetch('/admin/api/files/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
      body: JSON.stringify({ path: currentFilePath, content })
    });
    const data = await res.json();
    if (data.success) {
      showToast('File saved');
    } else {
      showToast(data.message, 'error');
    }
  } catch (err) {
    showToast('Failed to save', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-check-lg mr-1"></i>Save';
  }
}

// Keyboard shortcut: Ctrl+S / Cmd+S to save
document.getElementById('editorContent').addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveFile();
  }
  // Tab inserts spaces
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = this.selectionStart;
    const end = this.selectionEnd;
    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
    this.selectionStart = this.selectionEnd = start + 2;
  }
});

// New file
function openNewFileModal() {
  document.getElementById('newFileName').value = '';
  document.getElementById('newFileModal').classList.remove('hidden');
  document.getElementById('newFileName').focus();
}
function closeNewFileModal() { document.getElementById('newFileModal').classList.add('hidden'); }

async function createNewFile() {
  const name = document.getElementById('newFileName').value.trim();
  if (!name) { showToast('Enter a file name', 'error'); return; }

  try {
    const res = await fetch('/admin/api/files/write', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
      body: JSON.stringify({ path: currentDir + '/' + name, content: '' })
    });
    const data = await res.json();
    if (data.success) {
      showToast('File created');
      closeNewFileModal();
      location.reload();
    } else {
      showToast(data.message, 'error');
    }
  } catch (err) {
    showToast('Failed to create file', 'error');
  }
}

// New folder
function openNewFolderModal() {
  document.getElementById('newFolderName').value = '';
  document.getElementById('newFolderModal').classList.remove('hidden');
  document.getElementById('newFolderName').focus();
}
function closeNewFolderModal() { document.getElementById('newFolderModal').classList.add('hidden'); }

async function createNewFolder() {
  const name = document.getElementById('newFolderName').value.trim();
  if (!name) { showToast('Enter a folder name', 'error'); return; }

  try {
    const res = await fetch('/admin/api/files/mkdir', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
      body: JSON.stringify({ path: currentDir + '/' + name })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Folder created');
      closeNewFolderModal();
      location.reload();
    } else {
      showToast(data.message, 'error');
    }
  } catch (err) {
    showToast('Failed to create folder', 'error');
  }
}

// Delete
async function deleteItem(itemPath, name) {
  if (!confirm('Delete "' + name + '"? This cannot be undone.')) return;

  try {
    const res = await fetch('/admin/api/files/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
      body: JSON.stringify({ path: itemPath })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Deleted');
      location.reload();
    } else {
      showToast(data.message, 'error');
    }
  } catch (err) {
    showToast('Failed to delete', 'error');
  }
}

// Rename
async function renameItem(itemPath, oldName) {
  const newName = prompt('Rename "' + oldName + '" to:', oldName);
  if (!newName || newName === oldName) return;

  const dir = itemPath.substring(0, itemPath.lastIndexOf('/'));
  const newPath = dir + '/' + newName;

  try {
    const res = await fetch('/admin/api/files/rename', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
      body: JSON.stringify({ oldPath: itemPath, newPath })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Renamed');
      location.reload();
    } else {
      showToast(data.message, 'error');
    }
  } catch (err) {
    showToast('Failed to rename', 'error');
  }
}

// Enter key in modals
document.getElementById('newFileName').addEventListener('keydown', e => { if (e.key === 'Enter') createNewFile(); });
document.getElementById('newFolderName').addEventListener('keydown', e => { if (e.key === 'Enter') createNewFolder(); });
</script>

<%- include('../partials/footer') %>
